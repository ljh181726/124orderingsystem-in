<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>班級訂餐系統</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family: 'Inter', sans-serif; background: linear-gradient(-45deg,#f5f7fa,#c3cfe2,#d9a7c7,#fffcdc); background-size:400% 400%; animation:gradient 15s ease infinite; }
@keyframes gradient{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.container{animation:fadeIn 1s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
.hidden{display:none !important;}
</style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
<div class="container bg-white bg-opacity-80 p-6 sm:p-8 rounded-2xl shadow-2xl w-full max-w-2xl text-center">
  <div class="flex items-center justify-center mb-6">
    <span class="text-3xl sm:text-4xl mr-2">🍱</span>
    <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">班級訂餐系統</h1>
  </div>

  <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm text-center">
      <p id="messageText" class="text-lg font-medium text-gray-700 mb-4"></p>
      <button id="closeMessageBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition-all transform hover:scale-105">確定</button>
    </div>
  </div>

  <!-- User Area -->
  <div id="userArea" class="space-y-6">
    <button id="viewMenuBtn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">
      查看本週餐廳
    </button>
    <div id="menuDisplay" class="hidden text-left bg-gray-50 p-4 rounded-lg shadow-inner"></div>
    <div id="orderArea" class="mt-6 text-left"></div>
  </div>

  <!-- Admin Login Area -->
  <div id="adminLoginArea" class="hidden space-y-4">
    <h3 class="text-2xl font-bold text-gray-700">管理員登入</h3>
    <input type="password" id="adminPassword" placeholder="請輸入密碼" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
    <button id="adminLoginBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">登入</button>
    <button id="returnToUserBtn" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">返回使用者介面</button>
  </div>

  <!-- Admin Main Menu -->
  <div id="adminArea" class="space-y-6 hidden">
    <h3 class="text-2xl font-bold text-gray-700">管理員主選單</h3>
    <button id="viewOrdersBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">查看今日訂單列表</button>
    <button id="editMenuBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">設定本週菜單</button>
    <button id="returnToUserFromAdminMenu" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">返回使用者介面</button>
  </div>

  <!-- Admin: Menu Editor -->
  <div id="menuEditorArea" class="space-y-6 hidden">
    <h3 class="text-2xl font-bold text-gray-700">管理員：設定餐單</h3>
    <div class="flex flex-wrap items-center gap-2 mb-4">
      <input type="text" placeholder="餐點名稱" id="foodName" class="flex-grow px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      <input type="number" placeholder="價格" step="0.1" id="foodPrice" class="w-24 px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      <button id="addFoodBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-all transform hover:scale-105">新增餐點</button>
    </div>
    <ul id="foodList" class="space-y-2 text-left"></ul>
    <button id="returnToAdminMenuFromEditor" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">返回管理員主選單</button>
  </div>

  <!-- Admin: Order List -->
  <div id="orderListArea" class="space-y-6 hidden">
    <h3 class="text-2xl font-bold text-gray-700">今日訂單列表</h3>
    <div id="summaryArea" class="p-4 bg-yellow-100 rounded-lg shadow-md font-semibold text-gray-800">
      <p id="totalPriceDisplay">全班總價：$0</p>
      <p id="averagePriceDisplay">每人均價：$0</p>
    </div>
    <div id="ordersTable" class="bg-white p-4 rounded-lg shadow-md overflow-x-auto"></div>
    <div class="flex gap-2 mt-2">
      <button id="exportExcelBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">匯出 Excel</button>
    </div>
    <button id="returnToAdminMenuFromOrders" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md mt-2">返回管理員主選單</button>
  </div>

  <div class="mt-6 pt-6 border-t border-gray-200">
    <button id="toggleAdminBtn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">切換到管理員模式</button>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, collection, setDoc, onSnapshot, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

setLogLevel('debug');

// --------------------- Firebase Config ---------------------
const firebaseConfig = {
    apiKey: "AIzaSyCXfopJb3vTioZ8iQl34RgNHC7HENYllOg",
    authDomain: "ordering-system-in.firebaseapp.com",
    projectId: "ordering-system-in",
    storageBucket: "ordering-system-in.firebasestorage.app",
    messagingSenderId: "501137434058",
    appId: "1:501137434058:web:800fea249ac89230d6db33",
    measurementId: "G-HWMGTQRBG3"
};

const ADMIN_PASSWORD = "1234";
let weeklyMenuData = [];
let dailyOrdersData = {};
let db, auth, userId;

// Initialize Firebase
const app = initializeApp(firebaseConfig);
db = getFirestore(app);
auth = getAuth(app);
signInAnonymously(auth).then(()=>{userId = auth.currentUser.uid; initializeListeners();}).catch(e=>showMessage("Firebase login failed"));

// --------------------- Firestore Listeners ---------------------
function initializeListeners(){
  const menuDocRef = doc(db,"public_menu/menu_data");
  onSnapshot(menuDocRef,docSnap=>{
    if(docSnap.exists() && docSnap.data().menu){ weeklyMenuData = docSnap.data().menu; } 
    renderMenuEditor(); renderTodayMenu();
  },err=>console.error(err));

  const today = new Date().toISOString().slice(0,10);
  const ordersRef = collection(db,`public_orders/${today}/orders`);
  onSnapshot(query(ordersRef),snapshot=>{
    dailyOrdersData = {};
    snapshot.forEach(doc=>{ dailyOrdersData[doc.id]=doc.data(); });
    renderOrderList();
  },err=>console.error(err));
}

// --------------------- UI Functions ---------------------
function showMessage(msg){document.getElementById("messageText").innerText=msg; document.getElementById("messageBox").classList.remove("hidden");}
document.getElementById("closeMessageBtn").addEventListener("click",()=>{document.getElementById("messageBox").classList.add("hidden");});

// --------------------- Menu Editor ---------------------
function renderMenuEditor(){
  const list=document.getElementById("foodList"); list.innerHTML="";
  weeklyMenuData.forEach((f,i)=>{
    const li=document.createElement("li"); li.className="flex justify-between items-center py-2 px-3 bg-gray-100 rounded-md shadow-sm";
    li.innerHTML=`${f.name} - $${f.price.toFixed(1)} <button class="remove-btn text-red-500 hover:text-red-700 text-lg ml-2">🗑️</button>`;
    li.querySelector(".remove-btn").addEventListener("click",()=>{removeFood(i);});
    list.appendChild(li);
  });
}
document.getElementById("addFoodBtn").addEventListener("click",async()=>{
  const name=document.getElementById("foodName").value.trim();
  const price=parseFloat(document.getElementById("foodPrice").value);
  if(!name || isNaN(price)){showMessage("請輸入正確餐點與價格"); return;}
  weeklyMenuData.push({name,price}); document.getElementById("foodName").value=""; document.getElementById("foodPrice").value="";
  await updateMenuInFirestore();
});

async function removeFood(i){weeklyMenuData.splice(i,1); await updateMenuInFirestore();}
async function updateMenuInFirestore(){
  try{await setDoc(doc(db,"public_menu/menu_data"),{menu:weeklyMenuData}); renderMenuEditor(); showMessage("菜單已更新");} 
  catch(e){console.error(e); showMessage("更新失敗");} renderTodayMenu();
}

// --------------------- User: Today's Menu ---------------------
function renderTodayMenu(){
  const area=document.getElementById("orderArea"); 
  if(weeklyMenuData.length===0){ area.innerHTML="<p class='text-red-500 font-semibold'>餐單尚未設定</p>"; return;}
  let html=`<h3 class="text-2xl font-bold text-gray-700 mb-4">今日餐點</h3>
  <div class="mb-4"><label class="block text-gray-700 font-semibold mb-1">請輸入座號：</label>
  <input type="number" id="seatNumber" placeholder="座號" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>`;
  weeklyMenuData.forEach((f,i)=>{
    html+=`<div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg shadow-sm">
    <label class="flex-grow flex items-center"><input type="checkbox" id="food${i}" class="form-checkbox h-5 w-5 text-indigo-600 rounded-md transition-all"><span class="ml-3 text-gray-700 font-medium">${f.name}</span> <span class="ml-auto font-semibold text-gray-800">$${f.price.toFixed(1)}</span></label>
    <div class="ml-4 flex items-center"><span class="text-gray-600 mr-2">數量:</span><input type="number" min="1" value="1" id="qty${i}" class="w-16 px-2 py-1 text-center border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></div></div>`;
  });
  html+=`<button onclick="submitTodayOrder()" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">送出訂單</button>`;
  area.innerHTML=html;
}
window.submitTodayOrder=async function(){
  const seat=document.getElementById("seatNumber").value.trim();
  if(!seat || isNaN(seat) || seat<1 || seat>31){showMessage("請輸入有效座號"); return;}
  const order=[];
  let total=0;
  weeklyMenuData.forEach((f,i)=>{
    if(document.getElementById(`food${i}`).checked){
      const qty=parseInt(document.getElementById(`qty${i}`).value)||1;
      order.push({name:f.name,price:f.price,qty}); total+=f.price*qty;
    }
  });
  if(order.length===0){showMessage("請至少選擇一項餐點"); return;}
  const today=new Date().toISOString().slice(0,10);
  const orderDocRef=doc(db,`public_orders/${today}/orders`,seat);
  try{await setDoc(orderDocRef,{seatNumber:Number(seat),items:order,totalPrice:total,timestamp:new Date()}); 
    showMessage(`座號 ${seat} 訂單已送出\n總金額: ${total.toFixed(1)} 元`);} 
  catch(e){console.error(e); showMessage("訂單送出失敗");}
};

// --------------------- Admin: Orders ---------------------
function renderOrderList(){
  const table=document.getElementById("ordersTable");
  let total=0, count=0;
  let html=`<table class="min-w-full divide-y divide-gray-200">
  <thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">座號</th>
  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">餐點明細</th>
  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">總價</th>
  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">刪除</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
  const sorted=Object.keys(dailyOrdersData).sort((a,b)=>Number(a)-Number(b));
  if(sorted.length===0){html+=`<tr><td colspan="4" class="px-4 py-2 text-center text-gray-500">尚無訂單</td></tr>`;}
  else{sorted.forEach(seat=>{const o=dailyOrdersData[seat]; total+=o.totalPrice; count++;
    const items=o.items.map(x=>`${x.name} x ${x.qty} ($${(x.price*x.qty).toFixed(1)})`).join("<br>");
    html+=`<tr><td class="px-4 py-2 text-sm">${seat}</td><td class="px-4 py-2 text-sm">${items}</td><td class="px-4 py-2 text-sm">$${o.totalPrice.toFixed(1)}</td>
    <td class="px-4 py-2"><button class="deleteOrderBtn text-red-500 hover:text-red-700 text-lg">🗑️</button></td></tr>`;
  });}
  html+="</tbody></table>"; table.innerHTML=html;

  sorted.forEach(seat=>{ const btn=table.querySelector(`tr td .deleteOrderBtn`);
    if(btn) btn.addEventListener("click",()=>{deleteOrder(seat);}); });

  document.getElementById("totalPriceDisplay").textContent=`全班總價：$${total.toFixed(1)}`;
  const avg=count>0?(total/count).toFixed(2):0;
  document.getElementById("averagePriceDisplay").textContent=`訂單數：${count}，每人均價：$${avg}`;
}
async function deleteOrder(seat){const today=new Date().toISOString().slice(0,10);
  try{await deleteDoc(doc(db,`public_orders/${today}/orders`,seat)); showMessage(`已刪除座號 ${seat} 訂單`);}
  catch(e){console.error(e); showMessage("刪除失敗");}
}

// --------------------- Export ---------------------
document.getElementById("exportExcelBtn").addEventListener("click",()=>{
  const ws_data=[["座號","餐點明細","總價"]];
  Object.keys(dailyOrdersData).forEach(seat=>{
    const o=dailyOrdersData[seat];
    const items=o.items.map(x=>`${x.name} x ${x.qty}`).join(", ");
    ws_data.push([seat,items,o.totalPrice.toFixed(1)]);
  });
  const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"Orders"); XLSX.writeFile(wb,"orders.xlsx");
});

// --------------------- UI Buttons ---------------------
function toggleArea(area){
  ["userArea","adminArea","adminLoginArea","menuEditorArea","orderListArea"].forEach(id=>document.getElementById(id).classList.add("hidden"));
  if(area==="user") document.getElementById("userArea").classList.remove("hidden");
  else if(area==="adminMenu") document.getElementById("adminArea").classList.remove("hidden");
  else if(area==="menuEditor") document.getElementById("menuEditorArea").classList.remove("hidden");
  else if(area==="orderList") document.getElementById("orderListArea").classList.remove("hidden");
}

function toggleAdminLogin(){document.getElementById("userArea").classList.add("hidden"); document.getElementById("adminArea").classList.add("hidden"); document.getElementById("adminLoginArea").classList.remove("hidden");}
function checkAdminPassword(){if(document.getElementById("adminPassword").value===ADMIN_PASSWORD) toggleArea("adminMenu"); else showMessage("密碼錯誤");}

window.onload=function(){
  document.getElementById("toggleAdminBtn").addEventListener("click",toggleAdminLogin);
  document.getElementById("adminLoginBtn").addEventListener("click",checkAdminPassword);
  document.getElementById("returnToUserBtn").addEventListener("click",()=>toggleArea("user"));
  document.getElementById("viewOrdersBtn").addEventListener("click",()=>toggleArea("orderList"));
  document.getElementById("editMenuBtn").addEventListener("click",()=>toggleArea("menuEditor"));
  document.getElementById("returnToUserFromAdminMenu").addEventListener("click",()=>toggleArea("user"));
  document.getElementById("returnToAdminMenuFromEditor").addEventListener("click",()=>toggleArea("adminMenu"));
  document.getElementById("returnToAdminMenuFromOrders").addEventListener("click",()=>toggleArea("adminMenu"));
};

// Show weekly menu
document.getElementById("viewMenuBtn").addEventListener("click",()=>{
  const menu=document.getElementById("menuDisplay"); let html="<h3 class='text-xl font-semibold mb-4'>本週餐廳</h3><ul class='space-y-2'>";
  if(weeklyMenuData.length===0){html+="<li>尚未設定餐點</li>";} 
  else{weeklyMenuData.forEach(f=>{html+=`<li class="border-b border-gray-200 pb-2">${f.name} - $${f.price.toFixed(1)}</li>`;});}
  html+="</ul>"; menu.innerHTML=html; menu.classList.toggle("hidden");
});
</script>
</body>
</html>
