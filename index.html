<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¨‚é¤ç³»çµ± - æ ¡å…§ç‰ˆ</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background: linear-gradient(-45deg,#f5f7fa,#c3cfe2,#d9a7c7,#fffcdc);background-size:400% 400%;animation:gradient 15s ease infinite;}
@keyframes gradient {0% {background-position:0% 50%;}50% {background-position:100% 50%;}100% {background-position:0% 50%;}}
.container {animation: fadeIn 1s ease;}@keyframes fadeIn {from {opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
.hidden {display:none !important;}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
<div class="container bg-white bg-opacity-80 p-6 sm:p-8 rounded-2xl shadow-2xl w-full max-w-2xl text-center">

<div class="flex items-center justify-center mb-6">
<span class="text-3xl sm:text-4xl mr-2">ğŸ±</span>
<h1 class="text-3xl sm:text-4xl font-bold text-gray-800">ç­ç´šè¨‚é¤ç³»çµ±</h1>
</div>

<div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
<div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm text-center">
<p id="messageText" class="text-lg font-medium text-gray-700 mb-4"></p>
<button id="closeMessageBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition-all transform hover:scale-105">ç¢ºå®š</button>
</div>
</div>

<div id="userArea" class="space-y-6">
<div id="orderArea" class="mt-6 text-left"></div>
</div>

<div id="adminLoginArea" class="hidden space-y-4">
<h3 class="text-2xl font-bold text-gray-700">ç®¡ç†å“¡ç™»å…¥</h3>
<input type="password" id="adminPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
<button id="adminLoginBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">ç™»å…¥</button>
<button id="returnToUserBtn" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">è¿”å›ä½¿ç”¨è€…ä»‹é¢</button>
</div>

<div id="adminArea" class="space-y-6 hidden">
<h3 class="text-2xl font-bold text-gray-700">ç®¡ç†å“¡ä¸»é¸å–®</h3>
<button id="viewOrdersBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">æŸ¥çœ‹ä»Šæ—¥è¨‚å–®åˆ—è¡¨</button>
<button id="editMenuBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">è¨­å®šèœå–®</button>
<button id="returnToUserFromAdminMenu" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">è¿”å›ä½¿ç”¨è€…ä»‹é¢</button>
</div>

<div id="menuEditorArea" class="space-y-6 hidden">
<h3 class="text-2xl font-bold text-gray-700">ç®¡ç†å“¡ï¼šè¨­å®šçµ±ä¸€èœå–®</h3>
<div class="p-4 bg-white rounded-lg shadow-md space-y-4">
<div class="flex items-center gap-2">
<input type="text" placeholder="é¤å»³åç¨±" id="restaurantName" class="flex-grow px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
</div>
<div class="mt-4 border-t pt-4">
<h5 class="font-semibold text-gray-600 mb-2">é¤é»å“é …</h5>
<div class="flex flex-wrap items-center gap-2">
<input type="text" placeholder="é¤é»åç¨±" id="foodName" class="flex-grow px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
<input type="number" step="0.01" placeholder="åƒ¹æ ¼" id="foodPrice" class="w-24 px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
<button id="addFoodBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-all transform hover:scale-105">æ–°å¢é¤é»</button>
</div>
</div>
<ul id="menuList" class="space-y-2 text-left"></ul>
<button id="returnToAdminMenuFromEditor" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">è¿”å›ç®¡ç†å“¡ä¸»é¸å–®</button>
</div>
</div>

<div id="orderListArea" class="space-y-6 hidden">
<h3 class="text-2xl font-bold text-gray-700">ä»Šæ—¥è¨‚å–®åˆ—è¡¨</h3>
<div id="summaryArea" class="p-4 bg-yellow-100 rounded-lg shadow-md font-semibold text-gray-800">
<p id="totalPriceDisplay">å…¨ç­ç¸½åƒ¹ï¼š$0.00</p>
<p id="averagePriceDisplay">æ¯äººå‡åƒ¹ï¼š$0.00</p>
</div>
<div id="ordersTable" class="bg-white p-4 rounded-lg shadow-md overflow-x-auto"></div>
<div class="flex gap-2 justify-center">
<button id="exportExcelBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">åŒ¯å‡º Excel</button>
<button id="exportCsvBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">åŒ¯å‡º CSV</button>
</div>
<button id="returnToAdminMenuFromOrders" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">è¿”å›ç®¡ç†å“¡ä¸»é¸å–®</button>
</div>

<div class="mt-6 pt-6 border-t border-gray-200">
<button id="toggleAdminBtn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">åˆ‡æ›åˆ°ç®¡ç†å“¡æ¨¡å¼</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, onSnapshot, collection, setDoc, query, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

setLogLevel('debug');

const ADMIN_PASSWORD = "1234";
let db, auth, userId;
let menuData = {};
let dailyOrdersData = {};

const firebaseConfig = {
    apiKey: "AIzaSyCXfopJb3vTioZ8iQl34RgNHC7HENYllOg",
    authDomain: "ordering-system-in.firebaseapp.com",
    projectId: "ordering-system-in",
    storageBucket: "ordering-system-in.firebasestorage.app",
    messagingSenderId: "501137434058",
    appId: "1:501137434058:web:800fea249ac89230d6db33",
    measurementId: "G-HWMGTQRBG3"
};

try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    signInAnonymously(auth).then(() => {
        userId = auth.currentUser.uid;
        initializeListeners();
    });
} catch(e) { console.error(e); }

function initializeListeners() {
    initializeMenuListener();
    initializeOrderListener();
}

function initializeMenuListener() {
    const menuDocRef = doc(db,"public_menu/menu");
    onSnapshot(menuDocRef, async (docSnap)=>{
        if(docSnap.exists() && docSnap.data()) menuData = docSnap.data();
        else { menuData={restaurant:"æœªè¨­å®š",items:[]}; await setDoc(menuDocRef,menuData,{merge:true}); }
        renderTodayMenu(); renderMenuEditor();
    });
}

function initializeOrderListener() {
    const today = new Date().toISOString().slice(0,10);
    const ordersRef = collection(db,`public_daily_orders/${today}/orders`);
    onSnapshot(query(ordersRef),(qs)=>{
        dailyOrdersData={};
        qs.forEach(doc=>{dailyOrdersData[doc.id]=doc.data();});
        renderOrderList();
    });
}

function toggleArea(area){
    ["userArea","adminArea","adminLoginArea","menuEditorArea","orderListArea"].forEach(a=>document.getElementById(a).classList.add("hidden"));
    if(area==="user") document.getElementById("userArea").classList.remove("hidden");
    else if(area==="adminMenu") document.getElementById("adminArea").classList.remove("hidden");
    else if(area==="menuEditor") document.getElementById("menuEditorArea").classList.remove("hidden");
    else if(area==="orderList") document.getElementById("orderListArea").classList.remove("hidden");
}

function renderTodayMenu(){
    const area=document.getElementById("orderArea");
    if(!menuData.items || menuData.items.length===0){area.innerHTML="<p class='text-red-500 font-semibold'>èœå–®å°šæœªè¨­å®š</p>"; return;}
    let html=`<h3 class="text-2xl font-bold text-gray-700 mb-4">ä»Šæ—¥é¤é»ï¼š${menuData.restaurant}</h3>
    <div class="mb-4"><label for="seatNumber" class="block text-gray-700 font-semibold mb-1">è«‹è¼¸å…¥åº§è™Ÿï¼š</label>
    <input type="number" id="seatNumber" placeholder="åº§è™Ÿ" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
    <div class="space-y-4">`;
    menuData.items.forEach((f,idx)=>{
        const priceStr=Number(f.price||0).toFixed(2);
        html+=`<div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg shadow-sm">
        <label class="flex-grow flex items-center"><input type="checkbox" id="food${idx}" class="form-checkbox h-5 w-5 text-indigo-600 rounded-md transition-all">
        <span class="ml-3 text-gray-700 font-medium">${f.name}</span><span class="ml-auto font-semibold text-gray-800">$${priceStr}</span></label>
        <div class="ml-4 flex items-center"><span class="text-gray-600 mr-2">æ•¸é‡:</span>
        <input type="number" min="1" value="1" id="qty${idx}" class="w-16 px-2 py-1 text-center border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>
        </div>`;
    });
    html+=`</div><button onclick="submitTodayOrder()" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md">é€å‡ºè¨‚å–®</button>`;
    area.innerHTML=html;
}

async function submitTodayOrder(){
    const seatNumber=document.getElementById('seatNumber').value.trim();
    if(!seatNumber || isNaN(seatNumber) || seatNumber<1 || seatNumber>31){showMessage("è«‹è¼¸å…¥æœ‰æ•ˆåº§è™Ÿ (1-31)ï¼"); return;}
    const order=[]; let total=0;
    menuData.items.forEach((f,idx)=>{
        if(document.getElementById(`food${idx}`).checked){
            const qty=parseInt(document.getElementById(`qty${idx}`).value)||1;
            order.push({name:f.name,price:Number(f.price),qty});
            total+=Number(f.price)*qty;
        }
    });
    if(order.length===0){showMessage("è«‹è‡³å°‘é¸æ“‡ä¸€é …é¤é»ï¼"); return;}
    const today=new Date().toISOString().slice(0,10);
    const orderDocRef=doc(db,`public_daily_orders/${today}/orders`,seatNumber);
    const newOrder={seatNumber:Number(seatNumber),items:order,totalPrice:Number(total.toFixed(2)),timestamp:serverTimestamp()};
    try{await setDoc(orderDocRef,newOrder); showMessage(`åº§è™Ÿ ${seatNumber} è¨‚å–®å·²é€å‡ºï¼`); document.getElementById('seatNumber').value='';}
    catch(e){console.error(e); showMessage("é€å‡ºè¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤");}
}

function renderMenuEditor(){
    document.getElementById("restaurantName").value=menuData.restaurant||"";
    const list=document.getElementById("menuList"); list.innerHTML="";
    (menuData.items||[]).forEach((f,i)=>{
        const priceStr=Number(f.price||0).toFixed(2);
        const li=document.createElement("li");
        li.className="flex justify-between items-center py-2 px-3 bg-gray-100 rounded-md shadow-sm";
        li.innerHTML=`<span>${f.name} - $${priceStr}</span>
        <button class="remove-food-btn text-red-500 hover:text-red-700" data-index="${i}">ğŸ—‘ï¸</button>`;
        list.appendChild(li);
    });
    list.querySelectorAll(".remove-food-btn").forEach(btn=>{
        btn.addEventListener('click',async()=>{ if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ"))return; menuData.items.splice(btn.dataset.index,1); await setDoc(doc(db,"public_menu/menu"),menuData,{merge:true}); });
    });
}

document.getElementById("addFoodBtn").addEventListener("click",async()=>{
    const name=document.getElementById("foodName").value.trim();
    const price=parseFloat(document.getElementById("foodPrice").value);
    if(!name||isNaN(price)||price<0){showMessage("è«‹è¼¸å…¥æœ‰æ•ˆé¤é»åç¨±èˆ‡åƒ¹æ ¼"); return;}
    menuData.items=menuData.items||[];
    menuData.items.push({name,price}); await setDoc(doc(db,"public_menu/menu"),menuData,{merge:true});
    document.getElementById("foodName").value=""; document.getElementById("foodPrice").value="";
});

document.getElementById("restaurantName").addEventListener("change",async()=>{
    menuData.restaurant=document.getElementById("restaurantName").value.trim();
    await setDoc(doc(db,"public_menu/menu"),menuData,{merge:true});
});

async function deleteOrder(seatNumber){
    if(!confirm(`ç¢ºå®šåˆªé™¤åº§è™Ÿ ${seatNumber} çš„è¨‚å–®ï¼Ÿ`)) return;
    const today=new Date().toISOString().slice(0,10);
    await deleteDoc(doc(db,`public_daily_orders/${today}/orders`,seatNumber));
    showMessage(`åº§è™Ÿ ${seatNumber} çš„è¨‚å–®å·²åˆªé™¤ï¼`);
}

function renderOrderList(){
    let total=0, count=0;
    const table=document.getElementById("ordersTable");
    let html=`<table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50"><tr>
    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åº§è™Ÿ</th>
    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é¤é»æ˜ç´°</th>
    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç¸½åƒ¹</th>
    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
    </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

    const sorted=Object.keys(dailyOrdersData).sort((a,b)=>Number(a)-Number(b));
    if(sorted.length===0) html+=`<tr><td colspan="4" class="px-4 py-2 text-center text-gray-500">å°šç„¡è¨‚å–®</td></tr>`;
    else sorted.forEach(seat=>{
        const order=dailyOrdersData[seat];
        const itemsList=order.items.map(i=>`${i.name} x ${i.qty} ($${(i.price*i.qty).toFixed(2)})`).join('<br>');
        total+=order.totalPrice||0; count++;
        html+=`<tr><td class="px-4 py-2">${seat}</td><td class="px-4 py-2">${itemsList}</td><td class="px-4 py-2">$${(order.totalPrice||0).toFixed(2)}</td>
        <td class="px-4 py-2"><button onclick="deleteOrder('${seat}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded">åˆªé™¤</button></td></tr>`;
    });
    html+="</tbody></table>";
    table.innerHTML=html;
    document.getElementById("totalPriceDisplay").innerText=`å…¨ç­ç¸½åƒ¹ï¼š$${total.toFixed(2)}`;
    document.getElementById("averagePriceDisplay").innerText=`æ¯äººå‡åƒ¹ï¼š$${(count?total/count:0).toFixed(2)}`;
}

function showMessage(msg){document.getElementById("messageText").innerText=msg; document.getElementById("messageBox").classList.remove("hidden");}
document.getElementById("closeMessageBtn").addEventListener("click",()=>{document.getElementById("messageBox").classList.add("hidden");});

document.getElementById("toggleAdminBtn").addEventListener("click",()=>{toggleArea("adminLogin"); document.getElementById("adminLoginArea").classList.remove("hidden");});
document.getElementById("adminLoginBtn").addEventListener("click",()=>{if(document.getElementById("adminPassword").value===ADMIN_PASSWORD){toggleArea("adminMenu"); document.getElementById("adminLoginArea").classList.add("hidden");} else showMessage("å¯†ç¢¼éŒ¯èª¤ï¼");});
document.getElementById("returnToUserBtn").addEventListener("click",()=>{toggleArea("user");});
document.getElementById("returnToUserFromAdminMenu").addEventListener("click",()=>{toggleArea("user");});
document.getElementById("editMenuBtn").addEventListener("click",()=>{toggleArea("menuEditor");});
document.getElementById("viewOrdersBtn").addEventListener("click",()=>{toggleArea("orderList");});
document.getElementById("returnToAdminMenuFromEditor").addEventListener("click",()=>{toggleArea("adminMenu");});
document.getElementById("returnToAdminMenuFromOrders").addEventListener("click",()=>{toggleArea("adminMenu");});

document.getElementById("exportExcelBtn").addEventListener("click",()=>{exportData("excel");});
document.getElementById("exportCsvBtn").addEventListener("click",()=>{exportData("csv");});

function exportData(type){
    const wsData=[["åº§è™Ÿ","é¤é»æ˜ç´°","ç¸½åƒ¹"]];
    Object.keys(dailyOrdersData).forEach(seat=>{
        const order=dailyOrdersData[seat];
        const itemsStr=order.items.map(i=>`${i.name} x ${i.qty} ($${(i.price*i.qty).toFixed(2)})`).join('; ');
        wsData.push([seat,itemsStr,(order.totalPrice||0).toFixed(2)]);
    });
    const ws=XLSX.utils.aoa_to_sheet(wsData);
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"ä»Šæ—¥è¨‚å–®");
    if(type==="excel") XLSX.writeFile(wb,`ä»Šæ—¥è¨‚å–®.xlsx`);
    else if(type==="csv") XLSX.writeFile(wb,`ä»Šæ—¥è¨‚å–®.csv`);
}
</script>
</body>
</html>
